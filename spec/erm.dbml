Table Agent {
  name varchar [pk, note: "Agent 的唯一識別名稱"]
  llm_id varchar [ref: > LLM.model_id, note: "綁定的基礎模型 ID，可為 null (通用 Agent)"]
  description varchar [note: "Agent 的描述，用於列表顯示"]
  system_prompt text [note: "Agent 的核心指令 (System Prompt)"]
  status varchar [note: "Agent 狀態：Active (可用), Deleted (已刪除/軟刪除，可還原)"]
  created_by varchar [ref: > User.user_id, note: "建立者"]
  created_at datetime
  updated_at datetime
  
  Note: "定義系統中的對話代理人 (Agent)，封裝了 Prompt、模型配置與工具使用策略"
}

Table ToolTemplate {
  template_id varchar [pk, note: "工具模板唯一 ID，如 web_scraper"]
  name varchar [note: "模板名稱"]
  description varchar [note: "模板功能描述"]
  parameter_schema json [note: "JSON Schema 定義，描述該工具接受的參數結構"]
  created_at datetime
  updated_at datetime
  
  Note: "系統底層的工具定義 (Template)"
}

Table ToolInstance {
  instance_id varchar [pk, note: "工具實例 ID，如 ptt_scraper"]
  template_id varchar [ref: > ToolTemplate.template_id, note: "關聯模板，刪除模板會層聯刪除實例"]
  name varchar [note: "實例顯示名稱，如 'PTT Scraper'"]
  description varchar [note: "實例描述，會注入到 System Prompt"]
  configuration json [note: "預設參數值 (Config)，如 { target_site: 'ptt.cc' }"]
  created_by varchar [ref: > User.user_id]
  created_at datetime
  updated_at datetime
  
  Note: "使用者建立的具體工具實例 (Instance)"
}

Table AgentTool {
  agent_name varchar [ref: > Agent.name]
  tool_instance_id varchar [ref: > ToolInstance.instance_id]
  
  Note: "Agent 與 ToolInstance 的多對多關聯"
}

Table LLM {
  model_id varchar [pk, note: "模型 ID，如 gpt-4o"]
  status varchar [note: "模型狀態：Active (可用), Inactive (停用/隱藏)"]
  access_level varchar [note: "存取權限：Public, Admin-Only"]
  context_window int [note: "Context Window 大小 (Tokens)"]
  provider varchar [note: "模型供應商，如 OpenAI, Anthropic"]
  capabilities json [note: "模型能力清單，必須符合系統枚舉值：tool_use, vision, json_mode, streaming"]
  configuration json [note: "連線配置 (api_key, base_url 等)"]
  created_at datetime
  updated_at datetime
  
  Note: "LLM 註冊表，管理模型的生命週期與權限"
}

Table ChatTopic {
  topic_id varchar [pk, note: "對話主題 ID (Config Container)"]
  agent_id varchar [ref: > Agent.name, note: "此 Topic 基於哪個 Agent 建立"]
  user_id varchar [ref: > User.user_id, note: "建立此 Topic 的使用者"]
  current_llm_id varchar [ref: > LLM.model_id, note: "Topic 層級的模型覆寫。若 agent_id 指定的 Agent 未綁定 LLM，則此欄位必填。"]
  stm_window int [default: 10, note: "短期記憶視窗大小 (0: One-shot, 1-15: 訊息個數)"]
  created_at datetime
  updated_at datetime
  
  Note: "對話視窗的配置容器，管理模型參數與工具設定"
}

Table ChatSession {
  session_id varchar [pk, note: "對話場次 ID (History Container)"]
  topic_id varchar [ref: > ChatTopic.topic_id, note: "所屬 Topic"]
  is_active bool [note: "是否為當前活躍的 Session (True: 進行中, False: 已結束/封存)"]
  started_at datetime
  ended_at datetime
  created_at datetime
  updated_at datetime
  
  Note: "實際的對話場次，每次 Clear Topic 會產生新的 Session"
}

Table ChatMessage {
  message_id varchar [pk]
  session_id varchar [ref: > ChatSession.session_id]
  role varchar [note: "system, user, assistant, tool"]
  content json [note: "訊息內容，遵循 OpenAI API 格式 (含 content, tool_calls, tool_call_id 等)"]
  token_count int [note: "訊息 Token 數"]
  timestamp datetime
  created_at datetime
  updated_at datetime
  
  Note: "對話歷史訊息，歸屬於 Session。此資料採永久保留政策。"
}

Table User {
  user_id varchar [pk]
  role varchar [note: "Admin, User"]
  created_at datetime
  updated_at datetime
  
  Note: "系統使用者"
}

Table AuditLog {
  trace_id varchar [pk, note: "全局唯一的請求追蹤 ID"]
  user_id varchar [ref: > User.user_id]
  session_id varchar [ref: > ChatSession.session_id, note: "關聯的對話場次 ID，可用於追蹤對話過程的 API 細節"]
  status_code int [note: "HTTP 狀態碼"]
  duration_ms int [note: "處理耗時 (ms)"]
  error_type varchar [note: "錯誤類型，如 ValueError"]
  stack_trace text [note: "異常堆疊資訊"]
  path varchar [note: "API 請求路徑"]
  request_body json [note: "請求原始內容 (Body)，排除 Headers 以確保安全性"]
  response_body json
  created_at datetime
  updated_at datetime
  
  Note: "系統審計日誌，用於追蹤請求與排查問題。此資料採 90 天滾動保留政策。"
}

Table SystemAlert {
  alert_id varchar [pk]
  severity varchar [note: "High, Medium, Low"]
  source varchar [note: "警示來源服務"]
  reason varchar [note: "觸發原因"]
  timestamp datetime
  created_at datetime
  updated_at datetime
  
  Note: "系統內部發出的警示事件"
}
