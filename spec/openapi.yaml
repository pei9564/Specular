openapi: 3.0.3
info:
  title: Specular AI - Agent Management API
  description: |
    完整的 AI Agent 管理平台 API 規範，基於 AGUI (Agent User Interaction Protocol) 協議。
    
    ## 核心功能
    - **Agent 管理**: 建立、查詢、更新與刪除 AI Agent
    - **LLM 管理**: 管理與配置各種 LLM 模型
    - **工具管理**: 管理工具模板與工具實例
    - **對話管理**: Topic 與 Thread 的完整生命週期管理
    - **串流對話**: 基於 SSE 的即時串流對話
    - **審計追蹤**: 完整的請求記錄與可追蹤性
    
    ## 認證方式
    系統採用外部認證整合，透過信任的 HTTP Headers 識別使用者身份：
    - `X-User-ID`: 使用者唯一識別碼（必要）
    - `X-User-Role`: 使用者角色（USER 或 ADMIN）
    
  version: 1.0.0
  contact:
    name: Specular AI Team
  license:
    name: MIT

servers:
  - url: https://api.specular-ai.example.com/v1
    description: Production Server
  - url: http://localhost:8000/v1
    description: Development Server

tags:
  - name: Agents
    description: AI Agent 管理相關 API
  - name: LLMs
    description: LLM 模型管理相關 API
  - name: Tools
    description: 工具管理相關 API
  - name: Topics
    description: 對話主題管理相關 API
  - name: Messages
    description: 訊息與串流對話相關 API
  - name: Audit
    description: 審計日誌相關 API
  - name: System
    description: 系統維運相關 API

security:
  - ExternalAuth: []

paths:
  # ==================== Agent 相關 API ====================
  /agents:
    get:
      tags: [Agents]
      summary: 查詢 Agent 清單
      description: 取得所有可用的 Agent 清單，自動過濾已刪除的 Agent
      operationId: listAgents
      parameters:
        - name: status
          in: query
          description: 過濾 Agent 狀態
          schema:
            type: string
            enum: [ACTIVE, DELETED]
            default: ACTIVE
        - name: limit
          in: query
          description: 每頁筆數
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: offset
          in: query
          description: 偏移量
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 成功取得 Agent 清單
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AgentSummary'
                  total:
                    type: integer
                    description: 總筆數
                  limit:
                    type: integer
                  offset:
                    type: integer
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Agents]
      summary: 建立新的 Agent
      description: 建立一個新的 AI Agent，可綁定 LLM 與工具
      operationId: createAgent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAgentRequest'
      responses:
        '201':
          description: Agent 建立成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /agents/{id}:
    get:
      tags: [Agents]
      summary: 取得 Agent 詳細資訊
      description: 取得指定 Agent 的完整配置，包含 System Prompt、LLM 與工具清單
      operationId: getAgentDetails
      parameters:
        - $ref: '#/components/parameters/AgentId'
      responses:
        '200':
          description: 成功取得 Agent 詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [Agents]
      summary: 更新 Agent 配置
      description: 更新 Agent 的配置，包含 System Prompt、LLM 與工具
      operationId: updateAgent
      parameters:
        - $ref: '#/components/parameters/AgentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAgentRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Agents]
      summary: 刪除 Agent (軟刪除)
      description: 將 Agent 狀態變更為 DELETED，不進行物理刪除
      operationId: deleteAgent
      parameters:
        - $ref: '#/components/parameters/AgentId'
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Agent 已刪除
                  agentId:
                    type: string
        '404':
          $ref: '#/components/responses/NotFound'

  /agents/{id}/restore:
    post:
      tags: [Agents]
      summary: 還原已刪除的 Agent
      description: 將已刪除的 Agent 狀態還原為 ACTIVE（僅限管理員）
      operationId: restoreAgent
      parameters:
        - $ref: '#/components/parameters/AgentId'
      responses:
        '200':
          description: 還原成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Agent 已還原
                  agentId:
                    type: string
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== LLM 相關 API ====================
  /llms:
    get:
      tags: [LLMs]
      summary: 查詢可用的 LLM 模型
      description: 取得使用者有權限使用的 LLM 模型清單，自動根據使用者角色過濾
      operationId: listLLMs
      parameters:
        - name: status
          in: query
          description: 過濾模型狀態
          schema:
            type: string
            enum: [ACTIVE, INACTIVE]
            default: ACTIVE
      responses:
        '200':
          description: 成功取得 LLM 清單
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/LLM'
                  total:
                    type: integer
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

    post:
      tags: [LLMs]
      summary: 註冊新的 LLM 模型
      description: 註冊新的 LLM 模型（僅限管理員）
      operationId: registerLLM
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterLLMRequest'
      responses:
        '201':
          description: 模型註冊成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LLM'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /llms/{id}:
    get:
      tags: [LLMs]
      summary: 取得 LLM 模型詳情
      operationId: getLLMDetails
      parameters:
        - $ref: '#/components/parameters/LLMId'
      responses:
        '200':
          description: 成功取得 LLM 詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LLM'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [LLMs]
      summary: 更新 LLM 模型配置
      description: 更新模型狀態或存取權限（僅限管理員）
      operationId: updateLLM
      parameters:
        - $ref: '#/components/parameters/LLMId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLLMRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LLM'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== Tool 相關 API ====================
  /tool-templates:
    get:
      tags: [Tools]
      summary: 查詢工具模板清單
      description: 取得所有可用的工具模板
      operationId: listToolTemplates
      responses:
        '200':
          description: 成功取得工具模板清單
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ToolTemplate'
                  total:
                    type: integer

  /tool-templates/{id}:
    get:
      tags: [Tools]
      summary: 取得工具模板詳情
      operationId: getToolTemplateDetails
      parameters:
        - $ref: '#/components/parameters/ToolTemplateId'
      responses:
        '200':
          description: 成功取得工具模板詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToolTemplate'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Tools]
      summary: 刪除工具模板（僅限管理員）
      description: 刪除工具模板，將層聯刪除所有基於此模板的實例
      operationId: deleteToolTemplate
      parameters:
        - $ref: '#/components/parameters/ToolTemplateId'
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  templateId:
                    type: string
                  affectedInstances:
                    type: array
                    items:
                      type: string
                  affectedAgents:
                    type: array
                    items:
                      type: string
        '403':
          $ref: '#/components/responses/Forbidden'

  /tool-instances:
    get:
      tags: [Tools]
      summary: 查詢工具實例清單
      description: 取得使用者建立的工具實例
      operationId: listToolInstances
      parameters:
        - name: templateId
          in: query
          description: 過濾特定模板的實例
          schema:
            type: string
      responses:
        '200':
          description: 成功取得工具實例清單
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ToolInstance'
                  total:
                    type: integer

    post:
      tags: [Tools]
      summary: 建立工具實例
      description: 基於工具模板建立新的工具實例
      operationId: createToolInstance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateToolInstanceRequest'
      responses:
        '201':
          description: 工具實例建立成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToolInstance'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /tool-instances/{id}:
    get:
      tags: [Tools]
      summary: 取得工具實例詳情
      operationId: getToolInstanceDetails
      parameters:
        - $ref: '#/components/parameters/ToolInstanceId'
      responses:
        '200':
          description: 成功取得工具實例詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToolInstance'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [Tools]
      summary: 更新工具實例配置
      description: 更新工具實例的配置，變更會自動傳導到引用此工具的 Agent
      operationId: updateToolInstance
      parameters:
        - $ref: '#/components/parameters/ToolInstanceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateToolInstanceRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToolInstance'
        '400':
          $ref: '#/components/responses/BadRequest'

    delete:
      tags: [Tools]
      summary: 刪除工具實例
      description: 刪除工具實例，將自動從所有 Agent 中移除綁定
      operationId: deleteToolInstance
      parameters:
        - $ref: '#/components/parameters/ToolInstanceId'
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  id:
                    type: string

  # ==================== Topic 相關 API ====================
  /topics:
    get:
      tags: [Topics]
      summary: 查詢對話主題清單
      description: 取得使用者的對話主題清單，支援游標分頁
      operationId: listTopics
      parameters:
        - name: limit
          in: query
          description: 每頁筆數
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: cursor
          in: query
          description: 分頁游標
          schema:
            type: string
      responses:
        '200':
          description: 成功取得 Topic 清單
          content:
            application/json:
              schema:
                type: object
                properties:
                  topics:
                    type: array
                    items:
                      $ref: '#/components/schemas/TopicSummary'
                  nextCursor:
                    type: string
                    nullable: true
                  hasMore:
                    type: boolean

    post:
      tags: [Topics]
      summary: 建立新的對話主題
      description: 初始化一個新的 Topic，可基於 Agent 或直接指定 LLM
      operationId: createTopic
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTopicRequest'
      responses:
        '201':
          description: Topic 建立成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Topic'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /topics/{id}:
    get:
      tags: [Topics]
      summary: 取得 Topic 詳細資訊
      description: 取得 Topic 的配置與當前活躍線程的對話歷史
      operationId: getTopicDetails
      parameters:
        - $ref: '#/components/parameters/TopicId'
      responses:
        '200':
          description: 成功取得 Topic 詳情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicDetail'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [Topics]
      summary: 更新 Topic 配置
      description: 更新 Topic 的 LLM 或 STM 設定
      operationId: updateTopicConfig
      parameters:
        - $ref: '#/components/parameters/TopicId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTopicRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Topic'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /topics/{id}/clear:
    post:
      tags: [Topics]
      summary: 重置對話歷史
      description: 封存當前線程並建立新的線程
      operationId: clearTopic
      parameters:
        - $ref: '#/components/parameters/TopicId'
      responses:
        '200':
          description: 重置成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  oldThreadId:
                    type: string
                  newThreadId:
                    type: string

  # ==================== Message & Stream 相關 API ====================
  /topics/{id}/messages:
    post:
      tags: [Messages]
      summary: 發送訊息（觸發串流推論）
      description: |
        發送使用者訊息並觸發 AI 推論。
        回應為 Server-Sent Events (SSE) 串流，遵循 AGUI 協議。
        
        ## SSE 事件序列
        
        ### 正常流程（無工具）
        1. `RunStarted` - 推論開始
        2. `TextMessageStart` - 開始生成文字訊息
        3. `TextMessageContent` (多次) - 串流傳輸文字片段
        4. `TextMessageEnd` - 文字訊息結束
        5. `RunFinished` - 推論完成
        
        ### 包含工具調用
        1. `RunStarted`
        2. `ToolCallStart` - 開始工具調用
        3. `ToolCallArgs` (多次) - 串流傳輸工具參數
        4. `ToolCallEnd` - 工具參數傳輸完成
        5. `ToolCallResult` - 工具執行結果
        6. `TextMessageStart`
        7. `TextMessageContent` (多次)
        8. `TextMessageEnd`
        9. `RunFinished`
        
        ### 錯誤情況
        - `RunError` - 任何錯誤發生時觸發
        
      operationId: submitChatMessage
      parameters:
        - $ref: '#/components/parameters/TopicId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitMessageRequest'
      responses:
        '200':
          description: SSE 串流開始
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-Sent Events 串流
              examples:
                normalResponse:
                  summary: 正常回答（無工具）
                  value: |
                    event: RunStarted
                    data: {"runId":"run-1","threadId":"thread-1","timestamp":"2026-02-04T00:00:00Z"}

                    event: TextMessageStart
                    data: {"messageId":"msg-1","role":"assistant","timestamp":"2026-02-04T00:00:01Z"}

                    event: TextMessageContent
                    data: {"messageId":"msg-1","delta":"你好"}

                    event: TextMessageContent
                    data: {"messageId":"msg-1","delta":"，"}

                    event: TextMessageEnd
                    data: {"messageId":"msg-1","timestamp":"2026-02-04T00:00:02Z"}

                    event: RunFinished
                    data: {"runId":"run-1","threadId":"thread-1","usage":{"total_tokens":85}}
                
                toolUsage:
                  summary: 包含工具調用
                  value: |
                    event: RunStarted
                    data: {"runId":"run-2","threadId":"thread-2"}

                    event: ToolCallStart
                    data: {"toolCallId":"call-1","toolCallName":"Weather","parentMessageId":null}

                    event: ToolCallArgs
                    data: {"toolCallId":"call-1","delta":"{\"city\""}

                    event: ToolCallArgs
                    data: {"toolCallId":"call-1","delta":":\"Taipei\"}"}

                    event: ToolCallEnd
                    data: {"toolCallId":"call-1"}

                    event: ToolCallResult
                    data: {"toolCallId":"call-1","result":"25°C","isError":false}

                    event: TextMessageStart
                    data: {"messageId":"msg-2","role":"assistant"}

                    event: TextMessageContent
                    data: {"messageId":"msg-2","delta":"台北現在25度"}

                    event: TextMessageEnd
                    data: {"messageId":"msg-2"}

                    event: RunFinished
                    data: {"runId":"run-2","usage":{"total_tokens":150}}
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== Checkpoint 相關 API ====================
  /checkpoints/{id}/approve:
    post:
      tags: [Messages]
      summary: 批准敏感操作
      description: 批准 HITL 檢查點，允許執行敏感工具
      operationId: approveCheckpoint
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [APPROVE]
      responses:
        '200':
          description: 批准成功，工具將執行
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  checkpointId:
                    type: string
                  status:
                    type: string
                    enum: [RUNNING]

  /checkpoints/{id}/reject:
    post:
      tags: [Messages]
      summary: 拒絕敏感操作
      description: 拒絕 HITL 檢查點，阻止工具執行
      operationId: rejectCheckpoint
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [REJECT]
      responses:
        '200':
          description: 拒絕成功，工具不會執行
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  checkpointId:
                    type: string
                  status:
                    type: string
                    enum: [ABORTED]

  # ==================== Audit 相關 API ====================
  /audit-logs:
    get:
      tags: [Audit]
      summary: 查詢審計日誌
      description: 查詢審計日誌（僅限管理員）
      operationId: searchAuditLogs
      parameters:
        - name: traceId
          in: query
          description: 追蹤 ID
          schema:
            type: string
        - name: userId
          in: query
          description: 使用者 ID
          schema:
            type: string
        - name: startDate
          in: query
          description: 開始日期
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          description: 結束日期
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: 成功取得審計日誌
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLog'
                  total:
                    type: integer
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== System 相關 API ====================
  /health:
    get:
      tags: [System]
      summary: 健康檢查
      description: 檢查系統健康狀態
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: 系統正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: OK
                  timestamp:
                    type: string
                    format: date-time

components:
  securitySchemes:
    ExternalAuth:
      type: apiKey
      in: header
      name: X-User-ID
      description: 外部認證 Header，由上游 Gateway 提供

  parameters:
    AgentId:
      name: id
      in: path
      required: true
      description: Agent ID
      schema:
        type: string
        example: ag_001

    LLMId:
      name: id
      in: path
      required: true
      description: LLM ID
      schema:
        type: string
        example: llm_01

    ToolTemplateId:
      name: id
      in: path
      required: true
      description: Tool Template ID
      schema:
        type: string
        example: tmpl_01

    ToolInstanceId:
      name: id
      in: path
      required: true
      description: Tool Instance ID
      schema:
        type: string
        example: inst_001

    TopicId:
      name: id
      in: path
      required: true
      description: Topic ID
      schema:
        type: string
        example: topic_001

  schemas:
    # ==================== Agent Schemas ====================
    AgentSummary:
      type: object
      properties:
        id:
          type: string
          example: ag_001
        name:
          type: string
          example: MathGuru
        llmModel:
          type: string
          nullable: true
          example: gpt-4o
        tools:
          type: array
          items:
            type: string
          example: ["Calculator"]
        description:
          type: string
          example: 數學專家
        hasTools:
          type: boolean
          example: true

    Agent:
      type: object
      properties:
        id:
          type: string
          example: ag_001
        name:
          type: string
          example: MathGuru
        status:
          type: string
          enum: [ACTIVE, DELETED]
          example: ACTIVE
        systemPrompt:
          type: string
          example: You are a helpful math tutor. Use python for complex calc.
        llmId:
          type: string
          nullable: true
          example: llm_01
        llmModel:
          type: string
          nullable: true
          example: gpt-4o
        llmContextWindow:
          type: integer
          nullable: true
          example: 128000
        toolIds:
          type: array
          items:
            type: string
          example: ["tool_calc_v1"]
        tools:
          type: array
          items:
            type: string
          example: ["Calculator", "CodeInterpreter"]
        userId:
          type: string
          example: u_001
        createdAt:
          type: string
          format: date-time
          example: 2026-01-01T10:00:00Z
        updatedAt:
          type: string
          format: date-time
          nullable: true
        deletedAt:
          type: string
          format: date-time
          nullable: true

    CreateAgentRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: MathGuru
          minLength: 1
          maxLength: 100
        systemPrompt:
          type: string
          nullable: true
          example: You are a helpful AI assistant.
          description: 若不提供，將使用系統預設值
        llmId:
          type: string
          nullable: true
          example: llm_01
          description: 綁定的 LLM ID，可為 null（通用 Agent）
        toolIds:
          type: array
          items:
            type: string
          example: ["tool_calc_v1"]
          description: 綁定的工具實例 ID 清單

    UpdateAgentRequest:
      type: object
      properties:
        name:
          type: string
          example: Math Expert
        systemPrompt:
          type: string
          example: You are an advanced math tutor.
        llmId:
          type: string
          nullable: true
          example: llm_02
        toolIds:
          type: array
          items:
            type: string
          example: ["tool_calc_v2"]

    # ==================== LLM Schemas ====================
    LLM:
      type: object
      properties:
        id:
          type: string
          example: llm_01
        modelId:
          type: string
          example: gpt-4o
        provider:
          type: string
          example: openai
          enum: [openai, vllm, ollama]
        status:
          type: string
          enum: [ACTIVE, INACTIVE]
          example: ACTIVE
        accessLevel:
          type: string
          enum: [PUBLIC, ADMIN_ONLY]
          example: PUBLIC
        capabilities:
          type: array
          items:
            type: string
            enum: [tool_use, vision, json_mode, streaming]
          example: ["tool_use", "streaming"]
        contextWindow:
          type: integer
          example: 128000
        config:
          type: object
          additionalProperties: true
          example:
            baseUrl: https://api.openai.com/v1
            apiKey: "***"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true

    RegisterLLMRequest:
      type: object
      required:
        - modelId
        - provider
      properties:
        modelId:
          type: string
          example: internal-llama3-70b
        provider:
          type: string
          enum: [openai, vllm, ollama]
          example: vllm
        capabilities:
          type: array
          items:
            type: string
            enum: [tool_use, vision, json_mode, streaming]
          example: ["tool_use", "json_mode"]
        config:
          type: object
          additionalProperties: true
          example:
            baseUrl: http://10.0.0.5:8000/v1
            maxModelLen: 4096

    UpdateLLMRequest:
      type: object
      properties:
        status:
          type: string
          enum: [ACTIVE, INACTIVE]
          example: ACTIVE
        accessLevel:
          type: string
          enum: [PUBLIC, ADMIN_ONLY]
          example: PUBLIC

    # ==================== Tool Schemas ====================
    ToolTemplate:
      type: object
      properties:
        id:
          type: string
          example: tmpl_01
        name:
          type: string
          example: Web Scraper
        description:
          type: string
          example: 網頁爬蟲工具
        schema:
          type: object
          example:
            targetUrl:
              type: string
              required: true
        version:
          type: string
          example: "1.0"
        createdAt:
          type: string
          format: date-time

    ToolInstance:
      type: object
      properties:
        id:
          type: string
          example: inst_001
        name:
          type: string
          example: PTT Scraper
        templateId:
          type: string
          example: tmpl_01
        config:
          type: object
          example:
            targetUrl: ptt.cc
        userId:
          type: string
          example: u_001
        status:
          type: string
          enum: [ACTIVE, DELETED]
          example: ACTIVE
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true

    CreateToolInstanceRequest:
      type: object
      required:
        - name
        - templateId
        - config
      properties:
        name:
          type: string
          example: PTT Scraper
        templateId:
          type: string
          example: tmpl_01
        config:
          type: object
          example:
            targetUrl: ptt.cc

    UpdateToolInstanceRequest:
      type: object
      properties:
        name:
          type: string
          example: PTT Crawler v2
        config:
          type: object
          example:
            targetUrl: bbc.com

    # ==================== Topic Schemas ====================
    TopicSummary:
      type: object
      properties:
        id:
          type: string
          example: topic_001
        name:
          type: string
          example: Math Study
        agentId:
          type: string
          nullable: true
          example: ag_001
        llmId:
          type: string
          example: llm_01
        status:
          type: string
          enum: [ACTIVE]
          example: ACTIVE
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true

    Topic:
      type: object
      properties:
        id:
          type: string
          example: topic_001
        name:
          type: string
          example: Math Study
        agentId:
          type: string
          nullable: true
          example: ag_001
        llmId:
          type: string
          example: llm_01
        stmWindow:
          type: integer
          example: 10
          description: Short-term Memory 窗口大小
        userId:
          type: string
          example: u_001
        status:
          type: string
          enum: [ACTIVE]
          example: ACTIVE
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true

    TopicDetail:
      allOf:
        - $ref: '#/components/schemas/Topic'
        - type: object
          properties:
            config:
              type: object
              properties:
                currentLlm:
                  type: string
                  example: gpt-4o
                sourceAgent:
                  type: string
                  nullable: true
                  example: MathGuru
                activeTools:
                  type: array
                  items:
                    type: string
                  example: ["tool_calc_v1"]
            messages:
              type: array
              items:
                $ref: '#/components/schemas/ChatMessage'
            metadata:
              type: object
              properties:
                messageCount:
                  type: integer
                  example: 5
                tokenUsage:
                  type: object
                  properties:
                    total:
                      type: integer
                      example: 1250

    CreateTopicRequest:
      type: object
      properties:
        name:
          type: string
          example: Math Study
        agentId:
          type: string
          nullable: true
          example: ag_001
          description: 基於 Agent 建立（與 llmId 二選一）
        llmId:
          type: string
          nullable: true
          example: llm_01
          description: 直接指定 LLM（與 agentId 二選一）
        stmWindow:
          type: integer
          default: 10
          minimum: 0
          maximum: 100
          description: Short-term Memory 窗口大小

    UpdateTopicRequest:
      type: object
      properties:
        llmId:
          type: string
          example: llm_02
        stmWindow:
          type: integer
          example: 15

    # ==================== Message Schemas ====================
    ChatMessage:
      type: object
      properties:
        id:
          type: string
          example: msg_001
        threadId:
          type: string
          example: thread_01
        role:
          type: string
          enum: [USER, ASSISTANT, SYSTEM]
          example: USER
        content:
          type: string
          example: 幫我算 123 + 456
        sequence:
          type: integer
          example: 1
        createdAt:
          type: string
          format: date-time

    SubmitMessageRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          example: Hello AI
          minLength: 1

    # ==================== SSE Event Schemas ====================
    SSERunStarted:
      type: object
      required:
        - runId
        - threadId
        - timestamp
      properties:
        runId:
          type: string
          example: run-abc123
        threadId:
          type: string
          example: thread-xyz789
        timestamp:
          type: string
          format: date-time

    SSETextMessageStart:
      type: object
      required:
        - messageId
        - role
        - timestamp
      properties:
        messageId:
          type: string
          example: msg-001
        role:
          type: string
          enum: [assistant, system]
          example: assistant
        timestamp:
          type: string
          format: date-time

    SSETextMessageContent:
      type: object
      required:
        - messageId
        - delta
      properties:
        messageId:
          type: string
          example: msg-001
        delta:
          type: string
          example: 量子

    SSETextMessageEnd:
      type: object
      required:
        - messageId
        - timestamp
      properties:
        messageId:
          type: string
          example: msg-001
        timestamp:
          type: string
          format: date-time

    SSEToolCallStart:
      type: object
      required:
        - toolCallId
        - toolCallName
      properties:
        toolCallId:
          type: string
          example: call-xyz
        toolCallName:
          type: string
          example: search_arxiv
        parentMessageId:
          type: string
          nullable: true
          example: msg-001

    SSEToolCallArgs:
      type: object
      required:
        - toolCallId
        - delta
      properties:
        toolCallId:
          type: string
          example: call-xyz
        delta:
          type: string
          example: '{"query"'

    SSEToolCallEnd:
      type: object
      required:
        - toolCallId
      properties:
        toolCallId:
          type: string
          example: call-xyz

    SSEToolCallResult:
      type: object
      required:
        - toolCallId
        - result
        - isError
      properties:
        toolCallId:
          type: string
          example: call-xyz
        result:
          type: object
          additionalProperties: true
        isError:
          type: boolean
          example: false

    SSERunFinished:
      type: object
      required:
        - runId
        - threadId
      properties:
        runId:
          type: string
          example: run-abc123
        threadId:
          type: string
          example: thread-xyz789
        usage:
          type: object
          properties:
            total_tokens:
              type: integer
              example: 350
            prompt_tokens:
              type: integer
              example: 250
            completion_tokens:
              type: integer
              example: 100

    SSERunError:
      type: object
      required:
        - runId
        - code
        - message
      properties:
        runId:
          type: string
          example: run-abc123
        code:
          type: string
          enum:
            - token_limit
            - content_filter
            - quota_exceeded
            - connection_lost
            - model_inactive
            - aborted
          example: token_limit
        message:
          type: string
          example: 單次訊息過長，請嘗試縮減內容

    # ==================== Audit Schemas ====================
    AuditLog:
      type: object
      properties:
        id:
          type: string
          example: log_001
        traceId:
          type: string
          example: trace_abc123
        userId:
          type: string
          example: u_001
        endpoint:
          type: string
          example: /api/agents
        method:
          type: string
          example: POST
        statusCode:
          type: integer
          example: 201
        durationMs:
          type: integer
          example: 150
        requestBody:
          type: object
          nullable: true
        responseBody:
          type: object
          nullable: true
        errorType:
          type: string
          nullable: true
        errorMessage:
          type: string
          nullable: true
        stackTrace:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    # ==================== Error Schemas ====================
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: AGENT_NOT_FOUND
        message:
          type: string
          example: Agent ag_999 不存在
        details:
          type: object
          additionalProperties: true
          nullable: true

  responses:
    BadRequest:
      description: 請求參數錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: INVALID_REQUEST
            message: 參數驗證失敗

    Unauthorized:
      description: 未授權，缺少必要的身份驗證資訊
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: UNAUTHORIZED
            message: 缺少必要的身份驗證資訊

    Forbidden:
      description: 權限不足
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: PERMISSION_DENIED
            message: 您無權執行此操作

    NotFound:
      description: 資源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: RESOURCE_NOT_FOUND
            message: 請求的資源不存在

    InternalServerError:
      description: 伺服器內部錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: INTERNAL_SERVER_ERROR
            message: 系統發生錯誤

    ServiceUnavailable:
      description: 服務暫時無法使用
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: SERVICE_UNAVAILABLE
            message: 服務暫時無法使用，請稍後再試
