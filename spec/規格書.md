# PEGAAi Platform - 產品規格書

## 1. 產品概述

- **類型**：企業內部 Agent 開發平台
- **目標用戶**：開發人員與非技術人員
- **核心價值**：透過低程式碼/無程式碼 UI，讓使用者輕鬆創建和管理 AI Agent

---

## 2. 技術架構

### 2.1 技術棧

| 層級 | 技術選型 |
|------|----------|
| **前端** | React + Vite + TypeScript |
| **後端** | Python (FastAPI) |
| **Agent 框架** | AgentScope |
| **資料庫** | PostgreSQL |
| **向量資料庫** | Milvus |
| **訊息佇列** | Redis |
| **容器化** | Docker + Docker Compose |
| **編排** | Kubernetes |

### 2.2 系統架構圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             Frontend (React)                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │  Agent   │ │  Skill   │ │   MCP    │ │   RAG    │ │  Model   │ │ Monitor│ │
│  │ Builder  │ │ Manager  │ │ Manager  │ │ Manager  │ │ Manager  │ │  View  │ │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │ REST API / WebSocket
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Backend (Python FastAPI)                            │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌─────────────────────┐ │
│  │ Agent Service│ │ Skill Service│ │ Model Service│ │ AgentScope Runtime  │ │
│  │              │ │ MCP Service  │ │              │ │  ┌─────┐ ┌─────┐    │ │
│  │              │ │ RAG Service  │ │              │ │  │Agent│ │Agent│    │ │
│  │              │ │              │ │              │ │  └─────┘ └─────┘    │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                        Data Layer                                │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────────┐ │
│  │  PostgreSQL  │ │ Vector Store │ │         Redis            │ │
│  │  (Config DB) │ │    (RAG)     │ │    (Queue/Cache)         │ │
│  └──────────────┘ └──────────────┘ └──────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 部署架構

```
┌─────────────────────────────────────────────────────┐
│                 Docker Compose (本地)                │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────────┐ │
│  │Frontend │ │ Backend │ │PostgreSQL│ │   Redis   │ │
│  │Container│ │Container│ │Container │ │ Container │ │
│  └─────────┘ └─────────┘ └─────────┘ └───────────┘ │
│                                                     │
│  ┌─────────────────────────────────────────────────┤
│  │         Agent Runner Containers (隔離)          │ │
│  │  ┌───────┐ ┌───────┐ ┌───────┐                 │ │
│  │  │Agent 1│ │Agent 2│ │Agent N│                 │ │
│  │  └───────┘ └───────┘ └───────┘                 │ │
│  └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 3. 功能模組

### 3.0 Authentication（認證系統）

用戶認證與權限管理系統。

#### 3.0.1 用戶角色

| 角色 | 說明 | 權限範圍 |
|------|------|----------|
| `user` | 一般用戶 | 使用 Agent、Skills、MCP、RAG 等功能 |
| `admin` | 管理員 | 所有 user 權限 + 用戶管理 + 模型管理 |

#### 3.0.2 認證方式

- **JWT Token 認證**：登入後獲取 Access Token
- **Token 有效期**：24 小時
- **OAuth2 Password Flow**：標準 OAuth2 密碼授權流程

#### 3.0.3 安全措施

| 項目 | 實作方式 |
|------|----------|
| 密碼儲存 | bcrypt 雜湊加密 |
| Token 簽發 | JWT (HS256) |
| API Key 儲存 | Fernet 對稱加密 |
| 登入失敗訊息 | 統一錯誤訊息，避免帳號枚舉 |

#### 3.0.4 初始管理員

系統啟動時自動建立初始管理員帳號（可透過環境變數 `INITIAL_ADMIN_EMAIL` 與 `INITIAL_ADMIN_PASSWORD` 配置）：

- **Email**: `admin@pegatron.com` (預設)
- **Password**: `admin` (預設)

> ⚠️ 請在首次登入後立即更改密碼

---

### 3.1 Agent Builder（Agent 配置器）

低程式碼界面，讓使用者配置 Agent 的各項參數。

| 配置項 | 類型 | 說明 |
|--------|------|------|
| **名稱** | `string` | Agent 的顯示名稱與標識符 |
| **模型設定** | `object` | 選擇 LLM 模型及其參數 |
| **System Prompt** | `text` | Agent 的系統提示詞 |
| **Memory** | `memory_config` | 記憶模組配置 |
| **RAG 文件** | `file[]` | 上傳的知識庫文件 |
| **MCP 連接** | `mcp_config[]` | MCP Server 連接資訊 |
| **Skills** | `skill_id[]` | 選擇已註冊的 Skills |
| **Agent 模式** | `enum` | 對話模式 (chat) 或觸發器模式 (triggers) |

#### 3.1.1 Agent 綁定功能

在 Agent 創建和編輯界面中，提供以下綁定選擇器：

| 綁定類型 | UI 元件 | 說明 |
|----------|---------|------|
| **Skills** | Checkbox 列表 | 多選已註冊的 Skills，勾選後自動綁定 |
| **MCP 連接** | Checkbox 列表 | 多選 MCP Server 連接 |
| **RAG 知識庫** | 下拉選單 | 單選一個知識庫集合 |

**前端實作：**

- `CreateAgentModal`: 創建 Agent 時選擇綁定
- `EditAgentModal`: 編輯現有 Agent 的綁定
- 使用 React Query 獲取可用的 Skills/MCP/RAG 列表
- 即時顯示已選擇的項目名稱（非 ID）

#### 3.1.2 Agent 模式說明

| 模式 | 說明 | 使用場景 |
|------|------|----------|
| `chat` | 被動回應模式 | Agent 回應使用者訊息，適用於對話式應用 |
| `triggers` | 主動觸發模式 | Agent 根據事件或排程主動執行，適用於自動化任務 |

#### 3.1.3 模型設定子項目

Agent 的模型設定主要關聯自 `LLM Model` 註冊表。

```yaml
model_config:
  provider: string        # 模型提供者 (dashscope/openai/anthropic/azure_openai/custom)
  model_name: string      # 具體模型名稱 (gpt-4o, qwen-max 等)
  temperature: float      # 溫度 (0.0-2.0)
  stream: boolean         # 是否啟用串流 (預設: true)
  llm_model_id: string    # 關聯的 LLM Model 註冊表 ID
```

> [!NOTE]
> **API Key 安全機制**：Agent 的 `model_config` 不直接儲存 API Key。系統透過 `llm_model_id` 從 `llm_models` 表查詢並解密 API Key，再傳入 AgentScope Runtime。如果不指定 `llm_model_id`，則嘗試使用環境變數。

#### 3.1.4 Memory 配置

```yaml
memory_config:
  type: enum              # 記憶類型 (in_memory/database/reme)
  
  # 短期記憶設定
  working_memory:
    max_messages: int     # 最大保留訊息數 (預設: 20)
    compression: boolean  # 是否啟用記憶壓縮
    compression_model: string  # 壓縮使用的模型 (可選)
  
  # 長期記憶設定 (type=reme 時)
  long_term_memory:
    enabled: boolean      # 是否啟用長期記憶
    storage: enum         # 儲存方式 (sqlite/postgresql)
    embedding_model: string  # 嵌入模型
```

**Memory 類型說明：**

| 類型 | 說明 | 使用場景 |
|------|------|----------|
| `in_memory` | 記憶體儲存，重啟後清除 | 開發測試、短期對話 |
| `database` | 資料庫持久化儲存 | 需要保留對話歷史 |
| `reme` | ReMe 長期記憶系統 | 需要跨 Session 記憶能力 |

#### 3.1.5 MCP 連接配置

```yaml
mcp_config:
  name: string            # MCP 連接名稱
  transport: enum         # 傳輸方式 (sse/streamable_http/stdio)
  url: string             # MCP Server URL
  enabled_functions: list # 啟用的函數列表 (可選)
  preset_kwargs: dict     # 預設參數 (可選)
```

---

### 3.2 Skill Manager（技能管理器）

管理自定義 Python 工具函數。

#### 3.2.1 Skill 結構

```
skill/
├── SKILL.md              # 技能說明文件 (必要)
├── __init__.py           # 入口文件
├── functions.py          # 工具函數定義
├── requirements.txt      # 依賴套件 (可選)
└── resources/            # 額外資源 (可選)
```

#### 3.2.2 Skill 上傳流程

1. 使用者上傳 Skill 資料夾 (ZIP 格式)
2. 系統驗證 Skill 結構和程式碼安全性
3. 解析函數簽名，生成 JSON Schema
4. 儲存到 Skill 倉庫
5. 可供 Agent 選用

#### 3.2.3 Skill 函數規範

```python
from agentscope.tool import ToolResponse
from agentscope.message import TextBlock

def my_custom_tool(param1: str, param2: int = 10) -> ToolResponse:
    """工具函數的簡短描述
    
    這是工具函數的詳細說明，會被解析到 JSON Schema 中。
    
    Args:
        param1: 第一個參數的說明
        param2: 第二個參數的說明，預設值為 10
        
    Returns:
        工具執行的結果
    """
    # 實作邏輯
    result = f"處理結果: {param1}, {param2}"
    
    return ToolResponse(
        content=[TextBlock(type="text", text=result)]
    )
```

#### 3.2.4 Skill 詳細資訊視圖 (New)

提供 Skill 的完整資訊展示：

- **Config Tab**: 顯示基本資訊與 metadata (License, Compatibility, Allowed Tools 等)
- **Instructions Tab**: 渲染 `SKILL.md` 的 Markdown 內容
- **Files Tab**: 列出 Skill 資料夾內的文件結構與檔案大小
- **管理功能**: 下載 Skill (ZIP)、更新描述/狀態/相容性

---

### 3.3 MCP Manager（MCP 管理器）

管理外部 MCP Server 連接。

#### 3.3.1 功能列表

- 新增 MCP Server 連接資訊
- 測試連接有效性 (已實作)
- 查看可用工具列表 (已實作)
- 配置預設參數
- 函數級別的啟用/停用 (Phase 2)

---

### 3.4 RAG Manager（知識庫管理器）

管理 Agent 的知識庫文件。

#### 3.4.1 支援格式

| 格式 | 副檔名 |
|------|--------|
| 文字文件 | `.txt`, `.md` |
| 文檔 | `.pdf`, `.docx`, `.doc` |
| 表格 | `.xlsx`, `.csv` |
| 網頁 | `.html` |
| 程式碼 | `.py`, `.js`, `.ts`, `.java` 等 |

#### 3.4.2 處理流程 (Phase 2)

1. 上傳文件
2. 文件解析與分塊
3. 向量化嵌入
4. 儲存到向量資料庫
5. 關聯到指定 Agent

---

### 3.5 Agent Runtime（Agent 運行時）

基於 AgentScope 的 Agent 執行環境。

#### 3.5.0 API Key 解析流程

Agent 執行時的 API Key 取得遵循以下優先順序：

1. **LLM Model 註冊表**：透過 `model_config.llm_model_id` 查詢 `llm_models` 表，解密 `api_key_encrypted`。
2. **環境變數**：根據 provider 類型讀取對應環境變數（`DASHSCOPE_API_KEY`、`OPENAI_API_KEY`、`ANTHROPIC_API_KEY`）。

#### 3.5.1 Agent 類型

| 類型 | 說明 | 使用場景 |
|------|------|----------|
| **ReActAgent** | 推理-行動模式 | 通用工具使用 |
| **DialogAgent** | 對話模式 | 簡單對話場景 |
| **UserAgent** | 用戶代理 | 人機互動介面 |

#### 3.5.2 運行模式

- **同步模式**：單次請求-回應
- **串流模式**：即時串流輸出
- **非同步模式**：長時間任務，結果回調

---

### 3.6 Agent Chat（Agent 對話）

與 Agent 進行即時對話的功能模組。

#### 3.6.1 功能特點

| 功能 | 說明 |
|------|------|
| **即時對話** | 與 Agent 進行即時訊息交互 |
| **串流回應** | SSE Server-Sent Events 串流輸出 |
| **對話歷史** | 持久化儲存對話記錄 |
| **會話管理** | 創建、切換、刪除對話會話 |

#### 3.6.2 技術實作

- **API 端點**: `POST /agents/{id}/chat`, `POST /agents/{id}/chat/stream`
- **串流方式**: Server-Sent Events (SSE)
- **儲存**: PostgreSQL (Conversation + Message 表)

---

### 3.7 Triggers（觸發器）

Agent 主動觸發執行模式，支援排程、Webhook、事件驅動。

#### 3.7.1 觸發器類型

| 類型 | 說明 | 配置範例 |
|------|------|----------|
| **Schedule** | 排程觸發，使用 Cron 表達式 | `{"cron": "0 9 * * 1-5", "timezone": "Asia/Taipei"}` |
| **Webhook** | HTTP Webhook 觸發 | `{"allowed_methods": ["POST"], "secret": "xxx"}` |
| **Event** | 系統事件觸發 | `{"event_types": ["rag.document.uploaded"]}` |

#### 3.7.2 執行流程

1. 觸發器被觸發（排程時間到達 / 收到 Webhook / 系統事件）
2. 創建 TriggerExecution 記錄
3. 根據 input_template 生成 Agent 輸入
4. 調用 AgentScope Runtime 執行
5. 記錄執行結果

#### 3.7.3 Input Template

支援變數替換，將觸發資料傳入 Agent：

```
處理以下資料：{{payload}}
用戶名稱：{{payload.username}}
事件類型：{{event.type}}
```

---

### 3.8 Monitor（監控面板 - Phase 2）

Agent 運行狀態監控與追蹤。

#### 3.8.1 監控項目

- Agent 呼叫次數與響應時間
- Token 使用量統計
- 工具呼叫記錄
- 錯誤日誌
- OpenTelemetry Traces

---

### 3.9 LLM Model Manager（模型管理器）

管理 LLM 供應商與具體模型配置。

**權限說明：**

- 一般用戶：可查看已配置的供應商列表
- 管理員：可新增/編輯/刪除供應商、測試連線

**Agent 整合：** 建立 Agent 時，模型選擇僅限於 Model Manager 中已配置且啟用的供應商。

#### 3.9.1 支援的供應商類型

| 供應商 | 類型代碼 | 說明 |
|--------|----------|------|
| OpenAI | `openai` | OpenAI API |
| Anthropic | `anthropic` | Claude API |
| DashScope | `dashscope` | 阿里雲通義千問 |
| Azure OpenAI | `azure_openai` | Azure 託管的 OpenAI |
| Custom | `custom` | 自訂 OpenAI 相容 API |

#### 3.9.2 供應商配置項目

| 配置項 | 類型 | 說明 |
|--------|------|------|
| `display_name` | `string` | 顯示名稱 |
| `provider_type` | `enum` | 供應商類型 |
| `base_url` | `string` | API 端點（Azure/Custom 必填） |
| `api_key` | `string` | API 金鑰（Fernet 加密儲存） |
| `model_name` | `string` | 模型名稱（如 gpt-4o、qwen-max） |
| `model_config_json` | `object` | 額外配置（如 Azure 的 `api_version`） |
| `is_active` | `boolean` | 是否啟用 |
| `is_default` | `boolean` | 是否為系統預設 |

#### 3.9.3 Azure OpenAI 專屬配置

Azure OpenAI 需要額外配置項目：

| 配置項 | 存放位置 | 說明 |
|--------|----------|------|
| `base_url` | 頂層欄位 | Azure 端點（如 `https://xxx.openai.azure.com/`） |
| `api_version` | `model_config_json` | API 版本（如 `2024-06-01`），前端提供專用輸入欄 |

#### 3.9.4 連線測試

各供應商使用獨立的測試邏輯：

| 供應商 | 測試方式 | Header |
|--------|----------|--------|
| OpenAI | `GET {base_url}/models` | `Authorization: Bearer {key}` |
| Anthropic | `POST /v1/messages` | `x-api-key: {key}` |
| DashScope | `POST /generation` | `Authorization: Bearer {key}` |
| Azure OpenAI | `GET {endpoint}/openai/models?api-version=...` | `api-key: {key}` |
| Custom | `GET {base_url}/models` | `Authorization: Bearer {key}` |

#### 3.9.5 功能列表

- 新增/編輯/刪除 LLM 供應商
- 測試供應商連線狀態（各供應商使用正確的 API 格式）
- 設定系統預設供應商
- API Key 安全管理（Fernet 加密儲存、前端僅顯示 `has_api_key` 布林值）
- Azure OpenAI `api_version` 配置支援

---

### 3.10 UI/UX 功能

#### 3.10.1 主題切換

支援三種主題模式：

| 模式 | 說明 |
|------|------|
| `light` | 淺色主題 |
| `dark` | 深色主題 (OLED 優化) |
| `system` | 跟隨系統設定 |

**品牌色彩：**

- 主色調：金色 `#D4AF37`
- 深色背景：`#0F172A`
- 淺色背景：`#F8FAFC`

#### 3.10.2 多語言支援

支援語言切換功能：

| 語言 | 代碼 |
|------|------|
| 繁體中文 | `zh-TW` |
| English | `en` |

**實作方式：**

- 使用 i18next 進行國際化
- 使用者偏好儲存於 localStorage
- 預設語言：繁體中文

---

## 4. 資料模型

### 4.1 User 表

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(255),
    avatar_url VARCHAR(500),
    role VARCHAR(20) DEFAULT 'user',      -- user/admin
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_login_at TIMESTAMPTZ
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
```

### 4.2 LLM Model 表

```sql
CREATE TABLE llm_models (
    id UUID PRIMARY KEY,
    display_name VARCHAR(255) NOT NULL,   -- 顯示名稱
    description TEXT,
    provider_type VARCHAR(50) NOT NULL,   -- openai/anthropic/dashscope/azure_openai/custom
    base_url VARCHAR(500),
    api_key_encrypted TEXT,               -- Fernet 加密儲存
    model_name VARCHAR(100) NOT NULL,     -- 具體模型名稱 (如 gpt-4o)
    model_config_json JSONB,              -- 額外配置 (如 azure 的 api_version)
    is_active BOOLEAN DEFAULT TRUE,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);


```

### 4.3 Agent 表

```sql
CREATE TABLE agents (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    owner_id UUID REFERENCES users(id),
    
    -- 模型設定
    model_provider VARCHAR(50),
    model_name VARCHAR(100),
    model_config JSONB,
    
    -- 提示詞
    system_prompt TEXT,
    
    -- 記憶配置
    memory_type VARCHAR(20),       -- in_memory/database/reme
    memory_config JSONB,
    
    -- 關聯配置
    skill_ids UUID[],
    mcp_configs JSONB,
    rag_collection_id UUID,

    -- 元資料
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.4 Skill 表

```sql
CREATE TABLE skills (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    owner_id UUID REFERENCES users(id),
    
    -- 技能內容
    skill_path VARCHAR(500),
    functions JSONB,           -- 函數列表與 JSON Schema
    requirements TEXT,         -- pip requirements
    
    -- Metadata (New)
    license VARCHAR(100),
    compatibility VARCHAR(255),
    metadata_json JSONB,       -- 其他 metadata (author, version etc.)
    allowed_tools TEXT[],      -- 允許使用的工具
    file_count INT,
    original_filename VARCHAR(255),
    
    -- 狀態
    status VARCHAR(20),        -- draft/published/deprecated
    version VARCHAR(20),
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.5 MCP Connection 表

```sql
CREATE TABLE mcp_connections (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    owner_id UUID REFERENCES users(id),
    
    -- 連接設定
    transport VARCHAR(20),     -- sse/streamable_http/stdio
    url VARCHAR(500),
    auth_config JSONB,         -- 認證資訊 (加密)
    
    -- 函數配置
    available_functions JSONB,
    enabled_functions TEXT[],
    preset_kwargs JSONB,
    
    -- 狀態
    is_active BOOLEAN DEFAULT TRUE,
    last_health_check TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.6 RAG Collection 表

```sql
CREATE TABLE rag_collections (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    owner_id UUID REFERENCES users(id),

    -- 向量庫設定
    vector_store_type VARCHAR(50),
    collection_name VARCHAR(255),
    embedding_model VARCHAR(100),

    -- 文件統計
    document_count INT DEFAULT 0,
    total_chunks INT DEFAULT 0,

    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE rag_documents (
    id UUID PRIMARY KEY,
    collection_id UUID REFERENCES rag_collections(id),

    filename VARCHAR(500),
    file_type VARCHAR(50),
    file_size BIGINT,
    chunk_count INT,

    uploaded_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.7 Conversation 表

```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY,
    agent_id UUID REFERENCES agents(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL DEFAULT 'New Chat',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE messages (
    id UUID PRIMARY KEY,
    conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL,      -- user/assistant/system/tool
    content TEXT NOT NULL,
    metadata_json JSONB,            -- tool_calls, tokens, etc.
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.8 Trigger 表

```sql
CREATE TABLE triggers (
    id UUID PRIMARY KEY,
    agent_id UUID REFERENCES agents(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,

    -- 觸發器類型與配置
    trigger_type VARCHAR(20) NOT NULL,  -- schedule/webhook/event
    config JSONB NOT NULL,
    input_template TEXT,

    -- 狀態
    is_active BOOLEAN DEFAULT TRUE,
    last_triggered_at TIMESTAMPTZ,

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE trigger_executions (
    id UUID PRIMARY KEY,
    trigger_id UUID REFERENCES triggers(id) ON DELETE CASCADE,

    status VARCHAR(20) NOT NULL DEFAULT 'pending',  -- pending/running/completed/failed
    input_data JSONB,
    output_data JSONB,
    error_message TEXT,

    started_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);
```

---

## 5. API 設計

### 5.1 RESTful API 端點

```
# 認證 API
POST   /api/v1/auth/register          # 用戶註冊
POST   /api/v1/auth/login             # 用戶登入 (OAuth2 Password Flow)
GET    /api/v1/auth/me                # 獲取當前用戶資訊
PUT    /api/v1/auth/me                # 更新個人資料
POST   /api/v1/auth/change-password   # 更改密碼

# 用戶管理 (Admin Only)
GET    /api/v1/users                  # 列出所有用戶
GET    /api/v1/users/{id}             # 獲取用戶詳情
POST   /api/v1/users                  # 創建用戶
PUT    /api/v1/users/{id}/role        # 更新用戶角色
PUT    /api/v1/users/{id}/status      # 更新用戶狀態
DELETE /api/v1/users/{id}             # 刪除用戶

# LLM 模型管理 (LLM Models)
GET    /api/v1/llm-models              # 列出模型（所有用戶）
GET    /api/v1/llm-models/{id}         # 獲取模型詳情（所有用戶）
POST   /api/v1/llm-models              # 新增模型（Admin Only）
PUT    /api/v1/llm-models/{id}         # 更新模型（Admin Only）
DELETE /api/v1/llm-models/{id}         # 刪除模型（Admin Only）
POST   /api/v1/llm-models/test         # 測試新模型連線（Admin Only）
POST   /api/v1/llm-models/{id}/test    # 測試現有模型連線（Admin Only）

# Agent 管理
GET    /api/v1/agents              # 列出所有 Agent
POST   /api/v1/agents              # 創建 Agent
GET    /api/v1/agents/{id}         # 獲取 Agent 詳情
PUT    /api/v1/agents/{id}         # 更新 Agent
DELETE /api/v1/agents/{id}         # 刪除 Agent

# Agent 對話
POST   /api/v1/agents/{id}/chat           # 與 Agent 對話
POST   /api/v1/agents/{id}/chat/stream    # 串流對話 (SSE)
GET    /api/v1/agents/{id}/conversations  # 獲取對話列表
GET    /api/v1/agents/{id}/conversations/{conv_id}  # 獲取對話消息
DELETE /api/v1/agents/{id}/conversations/{conv_id}  # 刪除對話

# Agent 運行
POST   /api/v1/agents/{id}/run     # 執行任務

# 觸發器管理
GET    /api/v1/agents/{id}/triggers               # 列出觸發器
POST   /api/v1/agents/{id}/triggers               # 創建觸發器
GET    /api/v1/agents/{id}/triggers/{trigger_id}  # 獲取觸發器
PUT    /api/v1/agents/{id}/triggers/{trigger_id}  # 更新觸發器
DELETE /api/v1/agents/{id}/triggers/{trigger_id}  # 刪除觸發器
POST   /api/v1/agents/{id}/triggers/{trigger_id}/test  # 測試觸發器
GET    /api/v1/agents/{id}/triggers/{trigger_id}/executions  # 執行歷史

# Webhook 端點
POST   /api/v1/webhooks/triggers/{trigger_id}  # Webhook 觸發
GET    /api/v1/webhooks/triggers/{trigger_id}  # Webhook 觸發 (GET)

# Skill 管理
GET    /api/v1/skills              # 列出所有 Skills
POST   /api/v1/skills              # 上傳 Skill
GET    /api/v1/skills/{id}         # 獲取 Skill 詳情
PUT    /api/v1/skills/{id}         # 更新 Skill (描述, 狀態, 相容性等)
DELETE /api/v1/skills/{id}         # 刪除 Skill
GET    /api/v1/skills/{id}/download # 下載 Skill (ZIP)

# MCP 管理
GET    /api/v1/mcp-connections     # 列出 MCP 連接
POST   /api/v1/mcp-connections     # 新增 MCP 連接
POST   /api/v1/mcp-connections/{id}/test  # 測試連接與獲取工具列表
DELETE /api/v1/mcp-connections/{id}       # 刪除連接

# RAG 管理
GET    /api/v1/rag-collections     # 列出知識庫
POST   /api/v1/rag-collections     # 創建知識庫
POST   /api/v1/rag-collections/{id}/documents  # 上傳文件
DELETE /api/v1/rag-documents/{id}  # 刪除文件
```

```
(暫未實作，目前使用 SSE 單向串流)
```

---

## 6. 安全性考量

### 6.1 認證與授權

- JWT Token 認證
- RBAC 角色權限控制
- API Key 管理

### 6.2 Skill 執行安全

- Skill 程式碼靜態分析
- 沙箱環境執行 (Docker 容器隔離)
- 資源限制 (CPU/Memory/Network)
- 敏感 API 白名單控制

### 6.3 資料安全

- API Key 加密儲存
- 敏感配置加密
- 審計日誌

---

## 7. 開發階段規劃

### Phase 1: MVP

- [x] 基礎後端 API 框架 (FastAPI)
- [x] Agent CRUD 與基本配置
- [x] 與 AgentScope 整合
- [x] 簡單前端界面
- [x] Docker Compose 部署

### Phase 2: 核心功能

- [x] 用戶認證系統 (Authentication)
- [x] LLM 模型管理器 (Model Manager)
- [x] 基礎 Triggers 觸發器功能
- [x] Skill Manager: ZIP 上傳與自動解析
- [x] MCP Manager: 連線測試與工具列表
- [ ] RAG Manager: 文件預處理與向量化
- [ ] 完整 SSE 串流對話支援

### Phase 3: 進階功能

- [ ] Monitor 監控面板
- [ ] OpenTelemetry 整合
- [ ] 多 Agent 協作
- [ ] Kubernetes 部署配置

### Phase 4: 優化與擴展（持續）

- [ ] 效能優化
- [ ] Skill 市場
- [ ] Agent 模板
- [ ] 進階 RAG 策略

---

## 8. 相關參考

- [AgentScope GitHub](https://github.com/agentscope-ai/agentscope)
- [AgentScope Studio GitHub](https://github.com/agentscope-ai/agentscope-studio)
- [AgentScope Documentation](https://doc.agentscope.io/)
- [MCP (Model Context Protocol)](https://modelcontextprotocol.io/)
- [Anthropic Skills](https://github.com/anthropics/skills)

---

## 9. 版本歷史

| 版本 | 日期 | 說明 |
|------|------|------|
| 0.7.0 | 2026-02-05 | 確認 Skill Manager ZIP 上傳/下載與 MCP Manager 連線測試已實作。 |
| 0.6.0 | 2026-02-05 | 完善 Skill Manager 功能：新增 Skill 詳細資訊頁面（Config/Instructions/Files Tabs）、支援 Metadata 解析與顯示、支援 Skill 下載、更新部分 Skill 資訊 |
| 0.5.0 | 2026-02-04 | 修復 Agent Chat 中 API Key 未從 LLM Model 註冊表傳遞至 Runtime 的問題、修復 Azure OpenAI provider 類型識別與連線測試、新增 Azure OpenAI `api_version` 完整配置支援 |
| 0.4.0 | 2026-02-03 | 新增用戶認證系統（登入/登出/註冊）、用戶角色權限（user/admin）、LLM 模型管理頁面、Agent 建立時模型選擇整合 Model Manager |
| 0.3.0 | 2026-02-03 | 新增 Agent 綁定功能：Skills/MCP/RAG 選擇器、EditAgentModal 編輯功能 |
| 0.2.0 | 2026-02-02 | 新增 Agent Chat 功能、Triggers 功能、修復 RAG Collection 問題 |
| 0.1.0 | 2026-02-02 | 初始版本 |
