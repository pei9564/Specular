# .speckit/config/isa.yml
# Instruction Set Architecture for Test Generation

definitions:
  # --- 1. API Action (Trigger) ---
  # 用於 Integration Test：直接呼叫 API
  - pattern: "(UID={user_id}) {action}, call table:"
    type: "API_CALL"
    context: "When"
    python_template: |
      @when(parsers.parse('(UID={user_id}) {action}, call table:'))
      def api_call(client, user_id, action, datatable, mocker):
          # 1. Convert datatable to dict
          payload = [row.as_dict() for row in datatable][0]
          
          # 2. Lookup Endpoint from Plan mapping (This logic is generated by AI based on Plan)
          # endpoint_info = get_endpoint_for(action) 
          
          # 3. Headers
          headers = {"X-User-ID": user_id}
          
          # 4. Execute
          # Note: The actual implementation in test_step.py will act based on the Plan
          return client.request(method="POST", url=f"/api/{action_slug}", json=payload, headers=headers)

  # --- 2. API Verification (Assertion) ---
  - pattern: "回應, with table:"
    type: "API_ASSERT"
    context: "Then"
    python_template: |
      @then(parsers.parse('回應, with table:'))
      def verify_response(api_call, datatable):
          response = api_call
          expected = [row.as_dict() for row in datatable][0]
          
          # Status Code Check
          assert response.status_code == int(expected.get('status_code', 200))
          
          # Body Check
          actual = response.json()
          for k, v in expected.items():
              if k != 'status_code':
                  assert actual.get(k) == v

  # --- 3. Mock Setup ---
  - pattern: "外部服務 {service_name} 回傳:"
    type: "MOCK_SETUP"
    context: "Given"
    python_template: |
      @given(parsers.parse('外部服務 {service_name} 回傳:'))
      def mock_service(mocker, service_name, datatable):
          mock_data = [row.as_dict() for row in datatable][0]
          # Path defined in Plan
          mocker.patch(f"app.services.{service_name}.client", return_value=mock_data)